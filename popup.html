<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Application Assistant</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      width: 320px;
      min-height: 300px;
      padding: 16px;
      font-size: 14px;
      color: #333;
    }

    .container {
      width: 100%;
    }

    h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: #2d3142;
    }

    .form-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #4f5d75;
    }

    input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    input:focus {
      outline: none;
      border-color: #ef8354;
      box-shadow: 0 0 0 2px rgba(239, 131, 84, 0.2);
    }

    .btn {
      display: inline-block;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      text-align: center;
      margin-top: 8px;
      transition: background-color 0.2s, transform 0.1s;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background-color: #ef8354;
      color: white;
    }

    .btn-primary:hover {
      background-color: #e87444;
    }

    .btn-secondary {
      background-color: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
    }

    .btn-secondary:hover {
      background-color: #ebebeb;
    }

    .btn-text {
      background: none;
      color: #4f5d75;
      text-decoration: underline;
      padding: 4px;
      margin-top: 16px;
    }

    .btn-text:hover {
      color: #2d3142;
    }

    .error-message {
      color: #e74c3c;
      font-size: 12px;
      margin-top: 8px;
      min-height: 16px;
    }

    .user-info {
      display: flex;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid #eee;
      margin-bottom: 16px;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #2d3142;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .user-details {
      flex: 1;
      overflow: hidden;
    }

    .user-details div {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .text-muted {
      color: #888;
      font-size: 12px;
      margin-top: 2px;
    }

    .actions {
      margin-bottom: 16px;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
      margin-bottom: 12px;
    }

    .stat-item {
      text-align: center;
      flex: 1;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #2d3142;
    }

    .stat-label {
      font-size: 12px;
      color: #4f5d75;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ef8354;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .not-profolio-site {
      text-align: center;
      padding: 20px 0;
    }

    .info-icon {
      color: #4f5d75;
      font-size: 36px;
      margin-bottom: 12px;
    }

    .status-message {
      font-style: italic;
      text-align: center;
      margin: 8px 0;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Initial Loading State -->
    <div id="loading-view" class="loading">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>
    
    <!-- Not Profolio Site View -->
    <div id="not-profolio-view" style="display: none;">
      <div class="not-profolio-site">
        <div class="info-icon">ℹ️</div>
        <h2>Job Application Assistant</h2>
        <p>This extension works with your Profolio account.</p>
        <p class="status-message" id="login-status">Checking login status...</p>
        <div id="login-action-container" style="margin-top: 16px;">
          <a href="#" id="goto-profolio-btn" class="btn btn-primary">Go to Profolio</a>
        </div>
      </div>
    </div>
    
    <!-- Job Site View (after login on non-Profolio site) -->
    <div id="job-site-view" style="display: none;">
      <div class="user-info">
        <div class="avatar" id="user-avatar">J</div>
        <div class="user-details">
          <div id="user-name">John Doe</div>
          <div id="user-email" class="text-muted">john@example.com</div>
        </div>
      </div>
      
      <div class="actions">
        <button id="analyze-btn" class="btn btn-primary">Analyze This Page</button>
        <button id="autofill-btn" class="btn btn-secondary" disabled>Auto-Fill Form</button>
      </div>
      
      <div id="analysis-status" class="status-message"></div>
      
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="forms-filled">0</div>
          <div class="stat-label">Forms Filled</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="jobs-applied">0</div>
          <div class="stat-label">Jobs Applied</div>
        </div>
      </div>
      
      <a href="#" id="view-account-btn" class="btn btn-text">View Profolio Account</a>
    </div>
  </div>
  
  <script>
    // DOM Elements
    const loadingView = document.getElementById('loading-view');
    const notProfolioView = document.getElementById('not-profolio-view');
    const jobSiteView = document.getElementById('job-site-view');
    const loginStatus = document.getElementById('login-status');
    const analyzeBtn = document.getElementById('analyze-btn');
    const autofillBtn = document.getElementById('autofill-btn');
    const userAvatar = document.getElementById('user-avatar');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const formsFilled = document.getElementById('forms-filled');
    const jobsApplied = document.getElementById('jobs-applied');
    const gotoProfolioBtn = document.getElementById('goto-profolio-btn');
    const viewAccountBtn = document.getElementById('view-account-btn');
    const analysisStatus = document.getElementById('analysis-status');
    
    // Constants
    const PROFOLIO_DOMAIN = 'profolio.com'; // Change to your actual domain
    const PROFOLIO_URL = 'https://' + PROFOLIO_DOMAIN;
    
    // State
    let isProfolioSite = false;
    let isLoggedIn = false;
    let userData = null;
    let currentAnalysis = null;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Check if we're on a Profolio site
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        const url = new URL(tabs[0].url);
        isProfolioSite = url.hostname.includes(PROFOLIO_DOMAIN);
        
        // Check auth status
        const authResult = await checkAuth();
        isLoggedIn = authResult.isLoggedIn;
        userData = authResult.userData;
        
        if (isLoggedIn) {
          await loadUserStats();
          showJobSiteView();
        } else {
          showNotProfolioView();
        }
      } catch (error) {
        console.error('Initialization error:', error);
        showNotProfolioView();
        loginStatus.textContent = 'Error checking login status';
      }
    });
    
    // Check if the user is logged in
    async function checkAuth() {
      return new Promise((resolve) => {
        chrome.runtime.sendMessage({ action: 'checkAuth' }, (response) => {
          resolve(response || { isLoggedIn: false });
        });
      });
    }
    
    // Load user stats
    async function loadUserStats() {
      // In a real extension, you'd fetch this from your API
      // For now, we'll just use placeholder values
      formsFilled.textContent = '12';
      jobsApplied.textContent = '5';
    }
    
    // Show the job site view
    function showJobSiteView() {
      loadingView.style.display = 'none';
      notProfolioView.style.display = 'none';
      jobSiteView.style.display = 'block';
      
      if (userData) {
        userAvatar.textContent = userData.name?.charAt(0).toUpperCase() || 'U';
        userName.textContent = userData.name || 'User';
        userEmail.textContent = userData.email || '';
      }
    }
    
    // Show the not-Profolio site view
    function showNotProfolioView() {
      loadingView.style.display = 'none';
      jobSiteView.style.display = 'none';
      notProfolioView.style.display = 'block';
      
      if (isLoggedIn) {
        loginStatus.textContent = 'You are logged in to Profolio';
      } else {
        loginStatus.textContent = 'Please log in to your Profolio account';
      }
    }
    
    // Analyze the current page
    async function analyzeCurrentPage() {
      try {
        analysisStatus.textContent = 'Analyzing page...';
        
        // Get active tab
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        const activeTab = tabs[0];
        
        // Send message to content script
        const response = await new Promise(resolve => {
          chrome.tabs.sendMessage(
            activeTab.id,
            { action: 'startAnalysis' },
            resolve
          );
        });
        
        if (!response || !response.success) {
          analysisStatus.textContent = 'Analysis failed: ' + (response?.error || 'Unknown error');
          return;
        }
        
        currentAnalysis = response.analysis;
        analysisStatus.textContent = `Found ${currentAnalysis.fields?.length || 0} form fields`;
        autofillBtn.disabled = false;
        
        // Increment stats
        const filledCount = parseInt(formsFilled.textContent) || 0;
        formsFilled.textContent = (filledCount + 1).toString();
        
      } catch (error) {
        console.error('Analysis error:', error);
        analysisStatus.textContent = 'Error analyzing page';
      }
    }
    
    // Auto-fill the form
    async function autoFillForm() {
      try {
        analysisStatus.textContent = 'Filling form...';
        
        // Get active tab
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        const activeTab = tabs[0];
        
        // Send message to content script
        const response = await new Promise(resolve => {
          chrome.tabs.sendMessage(
            activeTab.id,
            { action: 'fillForm' },
            resolve
          );
        });
        
        if (!response || !response.success) {
          analysisStatus.textContent = 'Form fill failed: ' + (response?.error || 'Unknown error');
          return;
        }
        
        analysisStatus.textContent = 'Form filled successfully!';
        
        // Increment stats
        const appliedCount = parseInt(jobsApplied.textContent) || 0;
        jobsApplied.textContent = (appliedCount + 1).toString();
        
      } catch (error) {
        console.error('Form fill error:', error);
        analysisStatus.textContent = 'Error filling form';
      }
    }
    
    // Event Listeners
    gotoProfolioBtn.addEventListener('click', () => {
      chrome.tabs.create({ url: PROFOLIO_URL });
    });
    
    viewAccountBtn.addEventListener('click', () => {
      chrome.tabs.create({ url: PROFOLIO_URL + '/dashboard' });
    });
    
    analyzeBtn.addEventListener('click', () => {
      analyzeCurrentPage();
    });
    
    autofillBtn.addEventListener('click', () => {
      autoFillForm();
    });
  </script>
</body>
</html>
